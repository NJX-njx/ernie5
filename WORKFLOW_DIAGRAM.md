# 分支保护工作流程图 (Branch Protection Workflow)

## 完整的开发和合并流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        开发者工作流程                            │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐
│ 1. 创建分支   │
│   从 main    │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 2. 开发功能   │
│   编写代码    │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 3. 本地测试   │
│   pytest     │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 4. 格式化     │
│ black, isort │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 5. 提交推送   │
│   git push   │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│ 6. 创建 PR    │
│  填写模板     │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────────┐
│                        自动化检查流程                            │
└─────────────────────────────────────────────────────────────────┘

       ┌─────────────────┐
       │  CI/CD 触发      │
       └────────┬────────┘
                │
       ┌────────┴────────┐
       │                 │
       ▼                 ▼
┌─────────────┐   ┌─────────────┐
│ 测试任务     │   │ 代码质量    │
│ Python 3.8  │   │   Black     │
│ Python 3.9  │   │   isort     │
│ Python 3.10 │   │   Flake8    │
│ Python 3.11 │   │             │
└─────┬───────┘   └──────┬──────┘
      │                  │
      └────────┬─────────┘
               │
          ✓ 全部通过？
               │
               ▼
┌─────────────────────────────────────────────────────────────────┐
│                        代码审查流程                              │
└─────────────────────────────────────────────────────────────────┘

       ┌─────────────────┐
       │ CODEOWNERS 检查 │
       │  需要审查者      │
       └────────┬────────┘
                │
                ▼
       ┌─────────────────┐
       │   人工审查       │
       │  - 代码质量      │
       │  - 测试覆盖      │
       │  - 文档更新      │
       └────────┬────────┘
                │
          ✓ 批准？
                │
                ▼
       ┌─────────────────┐
       │  解决所有对话    │
       └────────┬────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────────────┐
│                           合并阶段                               │
└─────────────────────────────────────────────────────────────────┘

       ┌─────────────────┐
       │  最终检查         │
       │  ✓ CI 通过       │
       │  ✓ 审批获得      │
       │  ✓ 对话解决      │
       │  ✓ 分支最新      │
       └────────┬────────┘
                │
                ▼
       ┌─────────────────┐
       │  合并到 main     │
       │  (Squash merge) │
       └────────┬────────┘
                │
                ▼
       ┌─────────────────┐
       │   ✅ 完成！      │
       │  main 已更新     │
       └─────────────────┘
```

## 保护机制总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        Main 分支                                 │
│                      🔒 受保护分支                               │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
      ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
      │ 自动化保护    │ │  审查保护     │ │  流程保护     │
      └──────────────┘ └──────────────┘ └──────────────┘
              │               │               │
      ┌───────┴───────┐       │       ┌───────┴────────┐
      │               │       │       │                │
      ▼               ▼       ▼       ▼                ▼
  ┌──────┐      ┌──────┐ ┌──────┐ ┌──────┐       ┌──────┐
  │ CI/CD│      │ 代码  │ │COWNERS│ │ PR   │       │Issue │
  │ 测试 │      │ 质量  │ │ 审查  │ │ 模板 │       │ 模板 │
  └──────┘      └──────┘ └──────┘ └──────┘       └──────┘
```

## 关键检查点

```
Pull Request 创建
        │
        ├─→ ❶ PR 模板检查 ✓
        │
        ├─→ ❷ CI/CD 自动运行
        │      ├─→ 测试 (4个Python版本)
        │      └─→ 代码质量 (Black, isort, Flake8)
        │
        ├─→ ❸ CODEOWNERS 审查要求
        │      └─→ 至少1个审批
        │
        ├─→ ❹ 所有对话已解决
        │
        └─→ ❺ 分支必须是最新的
                │
                ▼
           ✅ 可以合并
```

## 权限矩阵

```
┌──────────────┬──────────┬──────────┬──────────┐
│   操作       │  开发者  │  审查者  │  管理员  │
├──────────────┼──────────┼──────────┼──────────┤
│ 直接推送main │    ❌    │    ❌    │    ❌    │
│ 创建PR       │    ✓     │    ✓     │    ✓     │
│ 审查代码     │    ✓     │    ✓     │    ✓     │
│ 批准PR       │    ✓*    │    ✓     │    ✓     │
│ 合并PR       │    ✓**   │    ✓**   │    ✓**   │
│ 修改保护规则 │    ❌    │    ❌    │    ✓     │
└──────────────┴──────────┴──────────┴──────────┘

* 不能批准自己的PR
** 只能在满足所有条件后合并
```

## 文档层次结构

```
                    README.md
                   (入口文档)
                        │
        ┌───────────────┼───────────────┐
        │               │               │
        ▼               ▼               ▼
 CONTRIBUTING.md  BRANCH_PROTECTION.md  QUICK_REFERENCE.md
 (贡献详细指南)    (分支保护配置)       (快速参考)
        │               │               │
        └───────────────┼───────────────┘
                        │
                        ▼
            IMPLEMENTATION_SUMMARY.md
                 (实施总结)
```

## 成功指标

```
✅ 代码质量
   ├─→ 所有测试通过
   ├─→ 代码格式正确
   └─→ 无代码质量问题

✅ 团队协作
   ├─→ 代码审查完成
   ├─→ 知识共享
   └─→ 对话已解决

✅ 流程规范
   ├─→ 使用PR模板
   ├─→ 遵循提交规范
   └─→ 文档已更新
```

---

**说明**: 此流程图展示了完整的分支保护机制和工作流程。所有变更都必须经过这些检查点才能合并到 main 分支。
